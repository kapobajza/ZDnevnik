services:
  promtail:
    env_file: ~/ZDnevnik/server/.env.prod
    environment:
      - LOKI_URL=http://loki:3100

  grafana:
    env_file: ~/ZDnevnik/server/.env.prod
    ports:
      - "3200"
    labels:
      - "traefik.enable=true"

  reverse_proxy:
    image: traefik:v3.1
    restart: unless-stopped
    command:
      # HTTP to HTTPS global redirection
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.websecure.http.tls=true"
      - "--log.level=DEBUG"
      # Dynamic configuration file for certs
      - "--providers.file.filename=/etc/traefik/dynamic/certs-config.yaml"
      # Docker configuration
      - "--providers.docker"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.endpoint=unix:///var/run/docker.sock"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.entrypoints=websecure"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ~/ZDnevnik/traefik/certs-config.yaml:/etc/traefik/dynamic/certs-config.yaml:ro
      - ~/ZDnevnik/traefik/certs:/etc/certs:ro

  postgres:
    image: postgres:15
    restart: always    
    env_file: ~/ZDnevnik/db/.env.prod
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ~/ZDnevnik/db/pg_hba.conf:/etc/postgresql/pg_hba.conf
      - ~/ZDnevnik/db/postgresql.conf:/etc/postgresql/postgresql.conf
    labels:
      - "promtail=true"
    command: ["postgres", "-c", "config_file=/etc/postgresql/postgresql.conf",
               "-c", "hba_file=/etc/postgresql/pg_hba.conf",]
    ports:
      - "5432:5432"

volumes:
  postgres_data: